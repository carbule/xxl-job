<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korant.youya.workplace.mapper.SysOrderMapper">

    <!--  查询订单列表  -->
    <select id="queryOrderList" resultType="com.korant.youya.workplace.pojo.vo.sysorder.SysOrderVo">
        SELECT o.order_id AS orderId,
        p.name AS productName,
        p.description AS productDescription,
        o.order_date AS orderDate,
        o.actual_amount AS actualAmount,
        o.status
        FROM yy_sys_order AS o
        LEFT JOIN yy_sys_virtual_product AS p ON o.sys_product_id = p.id AND p.is_delete = 0
        <where>
            o.buyer_id = #{walletAccountId}
            AND o.is_delete = 0
            <if test="queryOrderListDto.status != null ">
                AND o.status = #{queryOrderListDto.status}
            </if>
        </where>
        ORDER BY o.create_time DESC LIMIT #{queryOrderListDto.pageSize}
        OFFSET (#{queryOrderListDto.pageNumber} -1) * #{queryOrderListDto.pageSize}
    </select>

    <!--  查询已关闭订单列表  -->
    <select id="queryClosedOrderList" resultType="com.korant.youya.workplace.pojo.vo.sysorder.SysOrderVo">
        SELECT o.order_id      AS orderId,
               p.name          AS productName,
               p.description   AS productDescription,
               o.order_date    AS orderDate,
               o.actual_amount AS actualAmount,
               o.status
        FROM yy_sys_order AS o
                 LEFT JOIN yy_sys_virtual_product AS p ON o.sys_product_id = p.id AND p.is_delete = 0
        WHERE o.buyer_id = #{walletAccountId}
          AND o.status IN (4, 5, 6, 7, 8, 9)
          AND o.is_delete = 0
        ORDER BY o.create_time DESC LIMIT #{queryClosedOrderListDto.pageSize}
        OFFSET (#{queryClosedOrderListDto.pageNumber} -1) * #{queryClosedOrderListDto.pageSize}
    </select>

    <!--  批量插入子订单  -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO expected_position(id, order_id,sys_product_id, buyer_id, buyer_name,seller_id, seller_name, type,
        payment_method,
        order_date,quantity,
        total_amount,commission_amount,discount_amount,actual_amount,currency,out_transaction_id,status,invoice_id,createTime,isDelete)
        VALUES
        <foreach collection="list" item="param" index="index" separator=",">
            (
            #{param.id},
            #{param.orderId},
            #{param.sysProductId},
            #{param.buyerId},
            #{param.buyerName},
            #{param.sellerId},
            #{param.sellerName},
            #{param.type},
            #{param.paymentMethod},
            #{param.orderDate},
            #{param.quantity},
            #{param.totalAmount},
            #{param.commissionAmount},
            #{param.discountAmount},
            #{param.actualAmount},
            #{param.currency},
            #{param.outTransactionId},
            #{param.status},
            #{param.invoiceId},
            CURRENT_TIMESTAMP,
            0
            )
        </foreach>
    </insert>
</mapper>
