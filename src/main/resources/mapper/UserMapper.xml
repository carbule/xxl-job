<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korant.youya.workplace.mapper.UserMapper">
    <update id="resumePersonModify">
        UPDATE
            yy_user
        SET avatar                  = #{resumePersonModifyDto.avatar},
            last_name               = #{resumePersonModifyDto.lastName},
            first_name              = #{resumePersonModifyDto.firstName},
            gender                  = #{resumePersonModifyDto.gender},
            birthday                = #{resumePersonModifyDto.birthday},
            political_outlook       = #{resumePersonModifyDto.politicalOutlook},
            personal_signature      = #{resumePersonModifyDto.personalSignature},
            self_evaluation         = #{resumePersonModifyDto.selfEvaluation},
            update_time             = CURRENT_TIMESTAMP
        WHERE id = #{userId}
    </update>

    <update id="modifyResumeContactDetail">
        UPDATE yy_user
        SET country_code            = #{resumeContactModifyDto.countryCode},
            province_code           = #{resumeContactModifyDto.provinceCode},
            city_code               = #{resumeContactModifyDto.cityCode},
            district_code           = #{resumeContactModifyDto.districtCode},
            address                 = #{resumeContactModifyDto.address},
            phone                   = #{resumeContactModifyDto.phone},
            email                   = #{resumeContactModifyDto.email},
            qq                      = #{resumeContactModifyDto.qq},
            wechat_id               = #{resumeContactModifyDto.wechatId},
            update_time             = CURRENT_TIMESTAMP
        WHERE id = #{userId}
    </update>

    <select id="selectUserToLoginById" parameterType="java.lang.Long" resultType="com.korant.youya.workplace.pojo.LoginUser">
        SELECT u.id,
               u.phone,
               u.identity_card         AS identityCard,
               u.authentication_status AS authenticationStatus,
               u.account_status        AS accountStatus,
               r.role_name             AS role,
               e.id                    AS enterpriseId
        FROM yy_user AS u
                 LEFT JOIN yy_user_role AS ur ON u.id = ur.uid AND ur.is_delete = 0
                 LEFT JOIN yy_role AS r ON ur.rid = r.id
                 LEFT JOIN yy_user_enterprise AS ue ON u.id = ue.uid AND ue.is_delete = 0
                 LEFT JOIN enterprise AS e ON ue.enterprise_id = e.id
        WHERE u.id = #{id}
          AND u.is_delete = 0
    </select>

    <select id="selectUserToLoginByPhoneNumber" parameterType="java.lang.String"
            resultType="com.korant.youya.workplace.pojo.LoginUser">
        SELECT u.id,
               u.phone,
               u.identity_card         AS identityCard,
               u.authentication_status AS authenticationStatus,
               u.account_status        AS accountStatus,
               r.role_name             AS role,
               e.id                    AS enterpriseId
        FROM yy_user AS u
                 LEFT JOIN yy_user_role AS ur ON u.id = ur.uid AND ur.is_delete = 0
                 LEFT JOIN yy_role AS r ON ur.rid = r.id
                 LEFT JOIN yy_user_enterprise AS ue ON u.id = ue.uid AND ue.is_delete = 0
                 LEFT JOIN enterprise AS e ON ue.enterprise_id = e.id
        WHERE u.phone = #{phoneNumber}
          AND u.is_delete = 0
    </select>

    <select id="resumePersonDetail" resultType="com.korant.youya.workplace.pojo.vo.user.ResumePersonInfoVo">
        SELECT
            u.avatar,
            u.last_name            AS lastName,
            u.first_name           AS firstName,
            u.gender,
            u.birthday,
            u.political_outlook     AS  politicalOutlook,
            u.personal_signature    AS  personalSignature,
            u.self_evaluation       AS  selfEvaluation,
            u.authentication_status AS  authenticationStatus,
            e.name                  AS  userEnterprise
        FROM yy_user AS u
                 LEFT JOIN yy_user_enterprise AS ue ON u.id = ue.uid AND ue.is_delete = 0
                 LEFT JOIN enterprise AS e ON ue.enterprise_id = e.id AND e.is_delete = 0
        WHERE u.id = #{userId}
          AND u.is_delete = 0
    </select>

    <select id="resumePersonPreview"
            resultType="com.korant.youya.workplace.pojo.vo.user.ResumePersonPreviewVo">
        SELECT
            u.avatar,
            u.last_name                                  AS lastName,
            u.first_name                                 AS firstName,
            u.gender,
            DATE_PART('year', AGE(NOW(), u.birthday))    AS age,
            u.political_outlook                          AS  politicalOutlook,
            u.personal_signature                         AS  personalSignature,
            u.self_evaluation                            AS  selfEvaluation,
            u.authentication_status                      AS  authenticationStatus,
            u.phone,
            u.email,
            u.qq,
            u.wechat_id                                 AS wechatId,
            dp1.name                                    AS countryName,
            dp2.name                                    AS provinceName,
            dp3.name                                    AS cityName,
            dp4.name                                    AS districtName,
            u.address
        FROM yy_user AS u
                 LEFT JOIN   district_data dp1 ON dp1.code = u.country_code      AND dp1.is_delete = 0
                 LEFT JOIN   district_data dp2 ON dp2.code = u.province_code     AND dp2.is_delete = 0
                 LEFT JOIN   district_data dp3 ON dp3.code = u.city_code         AND dp3.is_delete = 0
                 LEFT JOIN   district_data dp4 ON dp4.code = u.district_code     AND dp4.is_delete = 0
        WHERE u.id = #{userId}
          AND u.is_delete = 0
    </select>

    <select id="resumeContactDetail" resultType="com.korant.youya.workplace.pojo.vo.user.ResumeContactInfoVo">
        SELECT
            u.phone,
            u.email,
            u.qq,
            u.wechat_id                AS wechatId,
            u.country_code             AS countryCode,
            dp1.name                   AS countryName,
            u.province_code            AS provinceCode,
            dp2.name                   AS provinceName,
            u.city_code                AS cityCode,
            dp3.name                   AS cityName,
            u.district_code            AS districtCode,
            dp4.name                   AS districtName,
            u.address
        FROM yy_user AS u
                 LEFT JOIN   district_data dp1 ON dp1.code = u.country_code      AND dp1.is_delete = 0
                 LEFT JOIN   district_data dp2 ON dp2.code = u.province_code     AND dp2.is_delete = 0
                 LEFT JOIN   district_data dp3 ON dp3.code = u.city_code         AND dp3.is_delete = 0
                 LEFT JOIN   district_data dp4 ON dp4.code = u.district_code     AND dp4.is_delete = 0
        WHERE u.id = #{userId}
          AND u.is_delete = 0
    </select>

</mapper>
